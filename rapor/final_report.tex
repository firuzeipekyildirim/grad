\documentclass[12pt]{article}

\usepackage[a4paper,margin=1in]{geometry}
\usepackage{amsmath,amssymb}
\usepackage{enumitem}
\usepackage{hyperref}

\setlist[itemize]{noitemsep, topsep=2pt}

\title{Mathematical Model: Single-Day VRPSPD with Operational Constraints and Backlog Penalties}
\date{}

\begin{document}
\maketitle

% =========================================================
\section{Problem Class}
% =========================================================
The project addresses a:
\textit{Capacitated Vehicle Routing Problem with Simultaneous Pickup and Delivery (VRPSPD)}
with route-length, stop-count, vehicle-capacity, route-duration (shift) and neighborhood-adjacency constraints.

This classification follows directly from:
\begin{itemize}
    \item simultaneous pickup and delivery at customer stops,
    \item dynamically changing vehicle load,
    \item capacity constraints,
    \item routes starting and ending at a single depot,
    \item no binding fleet size constraint (fleet chosen sufficiently large),
    \item operational constraints imposed by UPS (shift duration, stop limits, spatial compactness).
\end{itemize}

% =========================================================
\section{Sets and Indices}
% =========================================================
\begin{itemize}
    \item $N=\{0,1,\dots,n\}$: set of nodes; node $0$ is the depot (Istanbul Anadolu Aktarma Merkezi coordinates: $(40.920153,\,29.348245)$), and nodes $1,\dots,n$ are customer stops.
    \item $C = N\setminus\{0\}$: set of customer nodes.
    \item $K$: set of vehicles identified by unique IDs (vehicle dataset). Each $k\in K$ is a unique vehicle.
    \item $L$: set of neighborhoods (districts).
    \item $V$: set of vehicle types (stored as an attribute of each vehicle in the dataset).
    \item $R$: set of shipment types (e.g., $R=\{\text{Normal},\text{Urgent}\}$).
    \item Indices: $i,j\in N$ (nodes), $i,j\in C$ (customers), $k\in K$ (vehicles), $r\in R$ (shipment type).
\end{itemize}

% =========================================================
\section{Parameters}
% =========================================================
\begin{itemize}
    \item $d_{ij}$: distance between node $i$ and node $j$.
    \item $t_{ij}$: travel time between node $i$ and node $j$.
    \item $s_i$: service time at node $i$ ($s_0=0$).
    \item $Q$: vehicle capacity (350 packages).
    \item $S_{\min}$: minimum stops per route (80).
    \item $S_{\max}$: maximum stops per route (110).
    \item $T_{\min}$: minimum route duration (420 minutes, 7 hours).
    \item $T_{\max}$: maximum route duration (510 minutes, 8.5 hours).
    \item $h_i \in L$: neighborhood of node $i$.
    \item $A_{lm}\in\{0,1\}$: 1 if neighborhoods $l$ and $m$ are adjacent, 0 otherwise.
    \item $\text{type}_k \in V$: type attribute of vehicle $k$ (from the vehicle dataset).

    \item $F_k$: fixed cost of activating vehicle $k$.
    \item $c_k^{dist}$: distance cost coefficient for vehicle $k$.
    \item $c_k^{time}$: time cost coefficient for vehicle $k$.
    \item $c^{stop}$: per-stop cost (each visited customer stop).

    \item $P_{ir}$: pickup demand quantity at customer $i$ of shipment type $r$.
    \item $D_{ir}$: delivery demand quantity at customer $i$ of shipment type $r$.
    \item $P^{p}_{r}$: backlog penalty coefficient for pickup of type $r$.
    \item $P^{d}_{r}$: backlog penalty coefficient for delivery of type $r$.

    \item $M$: sufficiently large constant.
\end{itemize}

% =========================================================
\section{Decision Variables}
% =========================================================
\begin{itemize}
    \item $x_{kij}\in\{0,1\}$: 1 if vehicle $k$ travels from node $i$ to node $j$.
    \item $y_{ki}\in\{0,1\}$: 1 if customer node $i$ is visited/served by vehicle $k$.
    \item $z_k\in\{0,1\}$: 1 if vehicle $k$ is used (activated).

    \item $q_{ki}\ge 0$: load of vehicle $k$ after visiting node $i$.
    \item $a_{ki}\ge 0$: arrival time of vehicle $k$ at node $i$.
    \item $T_k\ge 0$: total route duration of vehicle $k$ (used for shift constraints, not in the objective).

    \item $\pi_{kir}\ge 0$: pickup amount of type $r$ collected by vehicle $k$ at customer $i$.
    \item $\delta_{kir}\ge 0$: delivery amount of type $r$ delivered by vehicle $k$ at customer $i$.

    \item $B^{p}_{ir}\ge 0$: pickup backlog amount for customer $i$ and type $r$.
    \item $B^{d}_{ir}\ge 0$: delivery backlog amount for customer $i$ and type $r$.

    \item $u_{ki}\ge 0$: MTZ ordering variable for subtour elimination.
\end{itemize}

% =========================================================
\section{Objective Function}
% =========================================================
Objective: Minimize total cost including distance/time costs (vehicle-dependent),
fixed vehicle activation cost, per-stop cost, and type-based backlog penalties.

\begin{equation}
\min Z
=
\sum_{k\in K}\sum_{i\in N}\sum_{\substack{j\in N\\ j\neq i}}
\Big( c_k^{dist}\, d_{ij} + c_k^{time}\, t_{ij} \Big)\, x_{kij}
\;+\;
\sum_{k\in K} F_k\, z_k
\;+\;
c^{stop}\sum_{k\in K}\sum_{i\in C} y_{ki}
\;+\;
\sum_{i\in C}\sum_{r\in R}
\Big( P^{p}_{r}\,B^{p}_{ir} + P^{d}_{r}\,B^{d}_{ir} \Big)
\end{equation}

\noindent\textbf{EN:} Total cost includes distance/time costs (vehicle-dependent), fixed vehicle usage cost,
per-stop cost, and type-based backlog penalties (Urgent has higher penalty).\\
\textbf{TR:} Toplam maliyet; mesafe/süre maliyetleri (araç bazlı), araç kullanım sabit maliyeti,
durak başı maliyet ve tür bazlı backlog cezasını içerir (Acil türün cezası daha yüksektir).

% =========================================================
\section{Constraints}
% =========================================================

\subsection{1) Customer Assignment}
Each customer is served exactly once:
\begin{equation}
\sum_{k \in K} y_{ki} = 1
\qquad \forall i \in C
\end{equation}

\subsection{2) Vehicle Activation}
A vehicle is active if it serves at least one customer:
\begin{equation}
\sum_{i \in C} y_{ki} \le M\,z_k
\qquad \forall k \in K
\end{equation}

\subsection{3) Flow Conservation (Linking $x$ and $y$)}
For each customer node, if it is served by vehicle $k$, it must have exactly one incoming and one outgoing arc:
\begin{equation}
\sum_{\substack{j\in N\\ j\neq i}} x_{kij} = y_{ki}
\qquad \forall i\in C,\;\forall k\in K
\end{equation}
\begin{equation}
\sum_{\substack{j\in N\\ j\neq i}} x_{kji} = y_{ki}
\qquad \forall i\in C,\;\forall k\in K
\end{equation}

\subsection{4) Depot Constraints}
Each active vehicle starts and ends at the depot:
\begin{equation}
\sum_{j \in C} x_{k0j} = z_k
\qquad \forall k \in K
\end{equation}
\begin{equation}
\sum_{i \in C} x_{ki0} = z_k
\qquad \forall k \in K
\end{equation}

\subsection{5) Stop Count Constraints}
\begin{equation}
S_{\min}\, z_k \le \sum_{i \in C} y_{ki} \le S_{\max}\, z_k
\qquad \forall k \in K
\end{equation}

\subsection{6) Neighborhood-Adjacency (Spatial Compactness)}
Vehicles cannot directly travel between non-adjacent neighborhoods:
\begin{equation}
x_{kij} \le A_{h_i h_j}
\qquad \forall i\in C,\;\forall j\in C,\; i\neq j,\;\forall k\in K
\end{equation}

\subsection{7) Backlog Definition (Single-Day)}
Unserved pickup/delivery demand becomes backlog (type-based):
\begin{equation}
\sum_{k\in K}\pi_{kir} + B^{p}_{ir} = P_{ir}
\qquad \forall i\in C,\;\forall r\in R
\end{equation}
\begin{equation}
\sum_{k\in K}\delta_{kir} + B^{d}_{ir} = D_{ir}
\qquad \forall i\in C,\;\forall r\in R
\end{equation}

Tie served quantities to whether customer is visited by vehicle $k$:
\begin{equation}
0 \le \pi_{kir} \le P_{ir}\, y_{ki}
\qquad \forall i\in C,\;\forall k\in K,\;\forall r\in R
\end{equation}
\begin{equation}
0 \le \delta_{kir} \le D_{ir}\, y_{ki}
\qquad \forall i\in C,\;\forall k\in K,\;\forall r\in R
\end{equation}

\subsection{8) Dynamic Capacity Constraints (Simultaneous Pickup \& Delivery)}
Initial load at depot equals total deliveries assigned to the vehicle:
\begin{equation}
q_{k0} = \sum_{i\in C}\sum_{r\in R}\delta_{kir}
\qquad \forall k\in K
\end{equation}

Load propagation along arcs (two-sided Big-M to enforce equality when $x_{kij}=1$):
\begin{equation}
q_{kj} \ge q_{ki} - \sum_{r\in R}\delta_{kjr} + \sum_{r\in R}\pi_{kjr} - M(1-x_{kij})
\qquad \forall i\in N,\;\forall j\in C,\; i\neq j,\;\forall k\in K
\end{equation}
\begin{equation}
q_{kj} \le q_{ki} - \sum_{r\in R}\delta_{kjr} + \sum_{r\in R}\pi_{kjr} + M(1-x_{kij})
\qquad \forall i\in N,\;\forall j\in C,\; i\neq j,\;\forall k\in K
\end{equation}

Capacity bounds:
\begin{equation}
0 \le q_{ki} \le Q
\qquad \forall i\in N,\;\forall k\in K
\end{equation}

\subsection{9) Route Duration (Shift) Constraints}
Time propagation:
\begin{equation}
a_{kj} \ge a_{ki} + s_i + t_{ij} - M(1-x_{kij})
\qquad \forall i\in N,\;\forall j\in N,\; i\neq j,\;\forall k\in K
\end{equation}

Fix start time at depot:
\begin{equation}
a_{k0}=0
\qquad \forall k\in K
\end{equation}

Route duration variable (arrival back to depot):
\begin{equation}
T_k \ge a_{ki} + s_i + t_{i0} - M(1-x_{ki0})
\qquad \forall i\in C,\;\forall k\in K
\end{equation}

Shift bounds:
\begin{equation}
T_{\min}\, z_k \le T_k \le T_{\max}\, z_k
\qquad \forall k\in K
\end{equation}

\subsection{10) Subtour Elimination (MTZ)}
MTZ constraints per vehicle:
\begin{equation}
u_{ki} - u_{kj} + |C|\,x_{kij} \le |C| - 1
\qquad \forall i\in C,\;\forall j\in C,\; i\neq j,\;\forall k\in K
\end{equation}
Link ordering to visits:
\begin{equation}
y_{ki} \le u_{ki} \le |C|\,y_{ki}
\qquad \forall i\in C,\;\forall k\in K
\end{equation}

\subsection{11) Variable Domains}
\begin{equation}
x_{kij},\,y_{ki},\,z_k \in \{0,1\}
\end{equation}
\begin{equation}
q_{ki}\ge 0,\quad a_{ki}\ge 0,\quad T_k\ge 0,\quad
\pi_{kir}\ge 0,\quad \delta_{kir}\ge 0,\quad
B^{p}_{ir}\ge 0,\quad B^{d}_{ir}\ge 0,\quad u_{ki}\ge 0
\end{equation}

\end{document}
